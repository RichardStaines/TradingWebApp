{% extends "base.html" %}

{% load humanize %}

{% block content %}

    <h1 class="my5">Positions</h1>
    <span class="mr-0">
    <a href="{% url 'trade.new' %}" class="btn btn-secondary">New Trade</a>
    <a href="{% url 'position.new' %}" class="btn btn-secondary">New Position</a>
    </span>
    <table id="datatable1" class="display stripe cell-border"
           style="width:100%" searching="true">
    <thead>

        <tr>
            <th>Portfolio</th>
            <th>Instrument</th>
            <th>Quantity</th>
            <th>Cost</th>
            <th>Average Price</th>
            <th>PnL</th>
            <th>Ex Div</th>
            <th>Div {{year}}</th>
            <th>Div {{last_year}}</th>
            <th>Div {{prev_year}}</th>
            <th>Created On</th>
            <th>Updated On</th>
            <th>Id</th>
            <th></th>
        </tr>
        <tr>
            <th>Portfolio</th>
            <th>Instrument</th>
            <th>Quantity</th>
            <th>Cost</th>
            <th>Average Price</th>
            <th>PnL</th>
            <th>Ex Div</th>
            <th>Div {{year}}</th>
            <th>Div {{last_year}}</th>
            <th>Div {{prev_year}}</th>
            <th>Created On</th>
            <th>Updated On</th>
            <th>Id</th>
            <th></th>
        </tr>
    </thead>
        <tbody>
            {% for row in positions %}
            <tr>
                <td>{{row.portfolio}}</td>
                <td>
                    <a href="{% url 'trade_by_portfolio_and_inst.list' portfolio=row.portfolio instrument=row.instrument %}"
                       class="test-dark text-decoration-non">
                        {{ row.instrument }}
                    </a>
                </td>
                <td>{{row.quantity |intcomma}}</td>
                <td>£{{row.cost.normalize |intcomma}}</td>
                <td>{{row.avg_price.normalize |intcomma}}</td>
                <td><span {% if row.pnl < 0 %} style="color: red;"
                          {% else %}style="color: blue;"
                          {% endif %}>
                    {{row.pnl.normalize |intcomma}} </span>
                </td>
                <td>{{row.ex_div_date}} {{row.div_payment_per_share.normalize | intcomma}}<br>
                    {% if row.quantity > 0 %}
                        {% if row.div_payment_per_share > 0 %}
                            <span style="color: blue;">{{row.payment_date}}
                            £{% widthratio row.div_payment_per_share 1 row.quantity %}
                        {% endif  %}
                    {% endif  %}
                    </span>
                </td>
                <td  style="color: blue;">{{row.div_ytd.normalize |intcomma}}</td>
                <td>{{row.div_last.normalize |intcomma}}</td>
                <td>{{row.div_prev.normalize |intcomma}}</td>
                <td>{{row.created_on}}</td>
                <td>{{row.updated_on}}</td>
                <td>
                    <button onclick="window.location.href='{% url 'position.update' pk=row.id %}'"
                            class="test-dark text-decoration-non">Edit {{row.id}}</button>
                </td>
                <td>
                    <button onclick="window.location.href='{% url 'position.delete' pk=row.id %}'"
                            class="test-dark text-decoration-non">Delete</button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
        <tfoot>
        <tr>
            <th></th>
            <th></th>
            <th></th>
            <th></th>
            <th></th>
            <th></th>
            <th></th>
            <th style="color: blue;"></th>
            <th></th>
            <th></th>
            <th></th>
            <th></th>
            <th></th>
            <th></th>
        </tr>
        </tfoot>
    </table>


<script>

    $(document).ready(function() {

        $('#datatable1').DataTable({
            order: [[0, 'asc'],[1, 'asc']],
            stateSave: true,
            autoWidth: true,
            columnDefs: [
                {
                    targets: [10,11], // your field position
                    type: 'datetime',
                    render: function (data, type, row, meta) {
                        var momentObj = moment(data, 'MMM. DD, YYYY, h:mm a');
                        if (type === 'sort') {
                            return momentObj.unix();
                        }
                        return momentObj.format('DD MMM YYYY HH:mm');
                    },
                    orderable: true
                }
            ],

            initComplete: function () {
                this.api()
                    .columns()
                    .every(function () {
                        let column = this;
                        let title = column.header().textContent;

                        // Create input element
                        let input = document.createElement('input');
                        input.placeholder = title;
                        column.header().replaceChildren(input);

                        // Event listener for user input
                        input.addEventListener('keyup', () => {
                            if (column.search() !== this.value) {
                                column.search(input.value).draw();
                            }
                        });
                    });
            },

        footerCallback: function (row, data, start, end, display) {
                let api = this.api();

                // Remove the formatting to get integer data for summation
                let intVal = function (i) {
                    return typeof i === 'string'
                        ? i.replace(/[\$£,]/g, '') * 1
                        : typeof i === 'number'
                        ? i
                        : 0;
                };

                // Total over all pages
                div_ytd = api
                    .column(7)
                    .data()
                    .reduce((a, b) => intVal(a) + intVal(b), 0);
                div_last = api
                    .column(8)
                    .data()
                    .reduce((a, b) => intVal(a) + intVal(b), 0);
                div_prev = api
                    .column(9)
                    .data()
                    .reduce((a, b) => intVal(a) + intVal(b), 0);

                // Total over this page
                var div_ytd = new Intl.NumberFormat("en-UK", {
                  style: "currency",
                  currency: "GBP"
                }).format(div_ytd);
                var div_last = new Intl.NumberFormat("en-UK", {
                  style: "currency",
                  currency: "GBP"
                }).format(div_last);
                var div_prev = new Intl.NumberFormat("en-UK", {
                  style: "currency",
                  currency: "GBP"
                }).format(div_prev);
                // Update footer
                api.column(7).footer().innerHTML = div_ytd;
                api.column(8).footer().innerHTML = div_last;
                api.column(9).footer().innerHTML = div_prev;
            }


        });
    } );

</script>

{% endblock %}