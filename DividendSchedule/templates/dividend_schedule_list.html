{% extends "base.html" %}

{% load humanize %}

{% block content %}

    <h1 class="my5">Dividend Schedules</h1>
    <span class="mr-0">
    <a href="{% url 'dividend_schedule.new' %}" class="btn btn-secondary">New Dividend Schedule</a>
    <a href="{% url 'dividend_schedule.scrape_urls_for_ex_div' %}" class="btn btn-secondary"
       onclick="startSpinner()">
        <span id="spinner-box" class="spinner-border spinner-border-sm not-visible" role="status" aria-hidden="true"></span>
        Scrape for Dividend Schedules</a>
    </span>

    <table id="datatable1" class="display stripe cell-border"
           style="width:100%" searching="true">
    <thead>

        <tr class="col-head">
            <th class="sorting_enabled">Instrument</th>
            <th class="sorting_enabled">ExDiv Date</th>
            <th class="sorting_enabled">Payment Date</th>
            <th class="sorting_enabled">Payment</th>
            <th class="sorting_enabled">Created On</th>
            <th class="sorting_enabled">Updated On</th>
            <th></th>
        </tr>
        <tr class="col-head">
            <th>Instrument</th>
            <th>ExDiv Date</th>
            <th>Payment Date</th>
            <th>Payment</th>
            <th>Created On</th>
            <th>Updated On</th>
            <th></th>
        </tr>
    </thead>
        <tbody>
            {% for row in dividend_schedules %}
            <tr>
                <td>
                    <a href="{% url 'dividend_schedule.details' pk=row.id %}" class="test-dark text-decoration-non">
                        {{ row.instrument }}
                    </a>
                </td>
                <td  data-sort="{{row.ex_div_date}}" >{{row.ex_div_date}}</td>
                <td>{{row.payment_date}}</td>
                <td>Â£{{row.payment.normalize |intcomma}}</td>
                <td>{{row.created_on}}</td>
                <td>{{row.updated_on}}</td>
                <td>
                    <i style="color: blue;" class="fa fa-edit"
                       onclick="window.location.href='{% url 'dividend_schedule.update' pk=row.id %}'">&nbsp;&nbsp;</i>
                    <i style="color: red;" class="fa fa-trash"
                       onclick="window.location.href='{% url 'dividend_schedule.delete' pk=row.id %}'"></i>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>


<script>

    function startSpinner() {
        const spinnerBox = document.getElementById('spinner-box')
        spinnerBox.classList.remove('not-visible')
    }

    $(document).ready(function() {

        $('#datatable1').DataTable({
            order: [[1, 'desc']],
            stateSave: true,
            columnDefs: [
                {
                    targets: [1,2], // your field position
                    type: 'datetime',
                    render: function (data, type, row, meta) {
                        var momentObj = moment(data, 'MMM. DD, YYYY');
                        if (type === 'sort') {
                            return momentObj.unix();
                        }
                        return momentObj.format('DD MMM YYYY');
                    },
                    orderable: true
                },
                {
                    targets: [4,5], // your field position
                    type: 'datetime',
                    render: function (data, type, row, meta) {
                        var momentObj = moment(data, 'MMM. DD, YYYY, h:mm a');
                        if (type === 'sort') {
                            return momentObj.unix();
                        }
                        return momentObj.format('DD MMM YYYY HH:mm');
                    },
                    orderable: true
                }
            ],

            initComplete: function () {
                this.api()
                    .columns()
                    .every(function () {
                        let column = this;
                        let title = column.header().textContent;

                        // Create input element
                        let input = document.createElement('input');
                        input.placeholder = title;
                        column.header().replaceChildren(input);

                        // Event listener for user input
                        input.addEventListener('keyup', () => {
                            if (column.search() !== this.value) {
                                column.search(input.value).draw();
                            }
                        });
                    });
            },

        });
    } );

</script>

{% endblock %}